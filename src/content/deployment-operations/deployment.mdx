---
title: 'Deployment'
date: '2024-06-28'
description: 'Learn how to deploy your Epic Stack application to Fly.io and other environments.'
draft: false
type: 'deployment-ops'
---

import GroupName from '../../components/docs/GroupName.astro'
import CodeBlock from '../../components/docs/CodeBlock.astro'

<GroupName>Deployment & Operations</GroupName>

# Deployment

This guide will walk you through deploying your Epic Stack application, primarily focusing on Fly.io deployment but also covering local deployment options.

## Deploying to Fly.io

Follow these steps to deploy your Epic Stack app to Fly.io:

1. Install Fly:
   Follow the [Fly installation guide](https://fly.io/docs/getting-started/installing-flyctl/).

2. Sign up and log in to Fly:

<CodeBlock code='fly auth signup' lang='bash' />

3. Create two apps on Fly (for staging and production):

<CodeBlock
  code={`fly apps create [YOUR_APP_NAME]
fly apps create [YOUR_APP_NAME]-staging`}
  lang='bash'
/>

4. Initialize Git:

<CodeBlock code='git init' lang='bash' />

5. Add secrets:
   - Add `FLY_API_TOKEN` to your GitHub repo secrets.
   - Set `SESSION_SECRET` and `HONEYPOT_SECRET` for both apps:

<CodeBlock
  code={`fly secrets set SESSION_SECRET=$(openssl rand -hex 32) HONEYPOT_SECRET=$(openssl rand -hex 32) --app [YOUR_APP_NAME]
fly secrets set SESSION_SECRET=$(openssl rand -hex 32) HONEYPOT_SECRET=$(openssl rand -hex 32) --app [YOUR_APP_NAME]-staging`}
  lang='bash'
/>

- Set `ALLOW_INDEXING` for the staging app:

<CodeBlock
  code='fly secrets set ALLOW_INDEXING=false --app [YOUR_APP_NAME]-staging'
  lang='bash'
/>

6. Create production database:

<CodeBlock
  code={`fly volumes create data --region sjc --size 1 --app [YOUR_APP_NAME]
fly volumes create data --region sjc --size 1 --app [YOUR_APP_NAME]-staging`}
  lang='bash'
/>

7. Attach Consul:

<CodeBlock
  code={`fly consul attach --app [YOUR_APP_NAME]
fly consul attach --app [YOUR_APP_NAME]-staging`}
  lang='bash'
/>

8. Commit and push your changes. The GitHub Action will handle deployment.

## Optional Setup

- [Email service setup](./email.md)
- [Error monitoring setup](./monitoring.md)
- [Connecting to your production database](./database.md)
- [Seeding Production](./database.md)

## Local Deployment

### Using Fly Locally

To deploy locally using Fly:

<CodeBlock
  code={`mv ./other/Dockerfile Dockerfile
mv ./other/.dockerignore .dockerignore
fly deploy
mv Dockerfile ./other/Dockerfile
mv .dockerignore ./other/.dockerignore`}
  lang='bash'
/>

### Using Docker/Podman

To deploy locally using Docker:

1. Modify the Dockerfile:

<CodeBlock
  code={`# prepare for litefs
VOLUME /litefs
ADD . .
EXPOSE \$\{PORT\}
ENTRYPOINT ["/myapp/other/docker-entry-point.sh"]`}
  lang='dockerfile'
/>

2. Create `other/docker-entry-point.sh`:

<CodeBlock 
  code={`#!/bin/sh -ex

npx prisma migrate deploy
sqlite3 /litefs/data/sqlite.db "PRAGMA journal_mode = WAL;"
sqlite3 /litefs/data/cache.db "PRAGMA journal_mode = WAL;"
npm run start`}
lang="bash"
/>

3. Build and run the Docker container:

<CodeBlock 
  code={`# Build the container
docker build -t epic-stack . -f other/Dockerfile --build-arg COMMIT_SHA=\`git rev-parse --short HEAD\`

# Create mountpoint for SQLite databases

mkdir ~/litefs

# Run the container

docker run -d -p 8081:8081 -e SESSION_SECRET='somesecret' -e HONEYPOT_SECRET='somesecret' -e FLY='false' -v ~/litefs:/litefs epic-stack`}
lang="bash"
/>

Your application should now be accessible at `http://localhost:8081`.

By following these steps, you can deploy your Epic Stack application to various environments, including Fly.io and local Docker setups.
